const express = require('express');
const router = express.Router();
const mysql = require('mysql');
const mysql_user = "test";
const mysql_password = "test";

// Connect to database and use Exploits table
function connectDatabase() {
    const con = mysql.createConnection({
        host: "localhost",
        user: mysql_user,
        password: mysql_password,
        database: "Can_You_EXPLOIT_It"
    });

    con.connect(function(err) {
        if (err) throw err;
    })
  
    return con;
}

// Show the home page
router.get('/', async (req, res, next) => {
    try {
        res.status(200).render('index');
    } catch (err) {
        next(err);
    }
});

// Search the exploits 
router.post('/search', async (req, res, next) => {
    try {
        // Get data from the post
        var targetSoftware = req.body.targetSoftware;
        var affectedVersion = req.body.affectedVersion;
        var exploitType = req.body.exploitType;
        var exploitPlatform = req.body.exploitPlatform;
        var exploitPort = req.body.exploitPort;
        var exploitAuthor = req.body.exploitAuthor;
        var parametersSearch = [{targetSoftware, affectedVersion, exploitType, exploitPlatform, exploitPort, exploitAuthor}];
        
        // Connect to database
        const con = connectDatabase();

        // Build the query
        const generalQuery = "SELECT * FROM Exploits ";
        var softwareQuery = "WHERE Description LIKE '%" + targetSoftware + "%' AND "
        var versionQuery =  "Description LIKE '%" + affectedVersion + "%' AND ";
        var typeQuery = "Type LIKE '%" + exploitType + "%' AND ";
        var platformQuery = "Platform LIKE '%" + exploitPlatform + "%' AND ";
        var portQuery = "Port LIKE '%" + exploitPort + "%' AND ";
        var authorQuery = "Author LIKE '%" + exploitAuthor + "%' ";
        var dateQuery = "ORDER BY Date DESC"
        var globalQuery = generalQuery + softwareQuery + versionQuery + typeQuery + platformQuery + portQuery + authorQuery + dateQuery;
        
        // Execute the query
        con.query(globalQuery, function(err, results) {
            if (err) throw err;
            res.status(200).render('index', { parametersSearch: parametersSearch, results: results});
        });

    } catch (err) {
        next(err);
    }
});

// Update the Searchsploit tool
router.post('/update', async (req, res, next) => {
    try {  
        const { spawn } = require('child_process');
        spawn("python3", [
            "update_searchsploit.py",
            mysql_user,
            mysql_password
        ], {stdio: "inherit", shell: true});

        res.status(200).render('index', { isUpdating: true});
    } catch (err) {
        next(err);
    }
});

module.exports = router;
