import sys, os, subprocess, re
from shutil import which
from colorama import init, Fore
import mysql.connector, getpass
from csv import reader

# Check if the OS is compatible 
def compatible_OS():
    # OS that are compatible 
    allowed_OS = ["linux", "linux1", "linux2"]

    if (sys.platform not in allowed_OS):
        print(Fore.RED + "Operating System not supported")
        sys.exit()
    else:
        print(Fore.GREEN + "Operating System supported")

# Check if the user have MySQL installed
def mysql_installed():   
    if which("mysql") is None:
        print(Fore.RED + "MySQL is not installed")
        print(Fore.RED + "Please, install it before continue with the setup")
        sys.exit()
    else:
        print(Fore.GREEN + "MySQL is installed")

# Check if mysql service is running
def mysql_status():  
    mysql_status = os.popen("ps ax |grep -v grep | grep mysql").read()

    if mysql_status == "":
        print(Fore.RED + "MySQL service is not running. Please, execute this command:")
        print(Fore.BLUE + "service mysql start")
        sys.exit()
    else:
        print(Fore.GREEN + "MySQL service is running")

# Check if searchsploit tool is installed
def searchsploit_installed():  
    if which("searchsploit") is None:
        print(Fore.RED + "Searchsploit is not installed")
        print(Fore.BLUE + "Installing it...")
        os.system("sudo apt -y install exploitdb 2> /dev/null")
        print(Fore.GREEN + "Installation completed")
    else:
        print(Fore.GREEN + "Searchsploit is installed")

# Check if nodejs is installed
def nodejs_installed():
    if which("node") is None:
        print(Fore.RED + "Nodejs is not installed")
        print(Fore.BLUE + "Installing it...")
        os.system("sudo curl -fsSL https://deb.nodesource.com/setup_15.x > /dev/null")
        os.system("sudo apt-get install -y nodejs > /dev/null")
        print(Fore.GREEN + "Installation completed")
    else:
        print(Fore.GREEN + "Nodejs is installed")

# Check if node_modules are installed
def node_modules_installed():
    if os.path.isdir('./node_modules') is False:
        print(Fore.RED + "Node Modules are not installed")
        print(Fore.BLUE + "Installing it...")
        os.system('sudo npm install')
        print(Fore.GREEN + "Installation completed")
    else:
        print(Fore.GREEN + "Node modules are installed")

# Connect with the database
def connect_database(mysql_user, mysql_password):
    exploit_database = mysql.connector.connect(
        host="localhost",
        user=mysql_user,
        password=mysql_password
    )

    return exploit_database

# Create the database and the exploits table
def create_database():
    print(Fore.WHITE + "Introduce the MySQL user and password to create the required database")
    mysql_user = input("User: ")
    mysql_password = getpass.getpass("Password: ")

    exploit_database = connect_database(mysql_user, mysql_password)

    mycursor = exploit_database.cursor()
    mycursor.execute("CREATE DATABASE IF NOT EXISTS Can_You_EXPLOIT_It")
    mycursor.execute("USE Can_You_EXPLOIT_It")
    mycursor.execute("""CREATE TABLE IF NOT EXISTS Exploits (
        ID varchar(255) NOT NULL, 
        File varchar(255) NOT NULL, 
        Description varchar(255) NOT NULL, 
        Date varchar(255) NOT NULL, 
        Author varchar(255) NOT NULL, 
        Type varchar(255) NOT NULL, 
        Platform varchar(255) NOT NULL, 
        Port varchar(255),
        SellerLink varchar(255),
        SoftwareLink varchar(255),
        Version varchar(255),
        Tested varchar(255),
        CVE varchar(255),
        PRIMARY KEY(ID))""")
    print(Fore.GREEN + "Database 'Can You EXPLOIT It' created")

    # Fill the database with the actual exploits
    update_database(exploit_database, mycursor)

# Insert the actual exploits in searchsploit in the database
def update_database(exploit_database, mycursor):
    print(Fore.BLUE + "Updating database...")
    
    # Read the CSV to get the basic information
    with open('/usr/share/exploitdb/files_exploits.csv','r') as read_obj:
        # Read the CSV and skip the first row (headers)
        csv_reader = reader(read_obj)
        next(csv_reader)

        # Insert each row in the table 
        for row in csv_reader:
            query = """INSERT IGNORE INTO Exploits (ID, File, Description, Date, Author, Type, Platform, Port, SellerLink, SoftwareLink, Version, Tested, CVE)
                       VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s)
                       """
            values = (row[0],row[1],row[2],row[3],row[4],row[5],row[6],row[7])
           
            # To get more information about the exploit 
            values = search_content(row[1], values)

            mycursor.execute(query, values)
            
    exploit_database.commit()
    print(Fore.GREEN + "Database update")

# Search the exploit content to find more information about it.
def search_content(exploit_path, values):
    # Add the root path to the exploit path
    exploit_path = "/usr/share/exploitdb/" + exploit_path

    # Specific variables to look for within each exploit
    seller_link = ""
    software_link = ""
    version = ""
    tested = ""
    CVE = ""

    # Open the file to read its content
    with open(exploit_path, 'r') as exploit:
        # Get all the lines of the file
        data = exploit.read().splitlines()
        
        # Iterate through them to find the key words and, after cleaning it, store them
        for line in data:             
            # Search and check the vendor link
            if re.search('[Vv]endor [Hh]omepage', line): 
                if (re.split('[Vv]endor [Hh]omepage', line)[1].strip().startswith(':')):
                    seller_link = clean_characters(line,'[Vv]endor [Hh]omepage',':')
                elif (re.split('[Vv]endor [Hh]omepage', line)[1].strip().startswith('-')):
                    seller_link = clean_characters(line,'[Vv]endor [Hh]omepage','-')
                elif (re.split('[Vv]endor [Hh]omepage', line)[1].startswith(' ')):
                    seller_link = clean_white(line,'[Vv]endor [Hh]omepage')
            elif re.search('[Vv]endor', line):
                if (re.split('[Vv]endor', line)[1].strip().startswith(':')):
                    seller_link = clean_characters(line,'[Vv]endor',':')
                elif (re.split('[Vv]endor', line)[1].strip().startswith('-')):
                    seller_link = clean_characters(line,'[Vv]endor','-')
                elif (re.split('[Vv]endor', line)[1].startswith(' ')):
                    seller_link = clean_white(line,'[Vv]endor')
                    
            # Search and check the software link
            if re.search('[Ss]oftware [Ll]ink', line):
                if (re.split('[Ss]oftware [Ll]ink', line)[1].strip().startswith(':')):
                    software_link = clean_characters(line,'[Ss]oftware [Ll]ink',':')
                elif (re.split('[Ss]oftware [Ll]ink', line)[1].strip().startswith('-')):
                    software_link = clean_characters(line,'[Ss]oftware [Ll]ink','-')
                elif (re.split('[Ss]oftware [Ll]ink', line)[1].startswith(' ')):
                    software_link = clean_white(line,'[Ss]oftware [Ll]ink')
            elif re.search('[Pp]roduct [Ww]eb [Pp]age', line):
                if (re.split('[Pp]roduct [Ww]eb [Pp]age', line)[1].strip().startswith(':')):
                    software_link = clean_characters(line,'[Pp]roduct [Ww]eb [Pp]age',':')
                elif (re.split('[Pp]roduct [Ww]eb [Pp]age', line)[1].strip().startswith('-')):
                    software_link = clean_characters(line,'[Pp]roduct [Ww]eb [Pp]age','-')
                elif (re.split('[Pp]roduct [Ww]eb [Pp]age', line)[1].startswith(' ')):
                    software_link = clean_white(line,'[Pp]roduct [Ww]eb [Pp]age')

            # Search and check the affected version
            if re.search('[Vv]ersion', line):
                if (re.split('[Vv]ersion', line)[1].strip().startswith(':')):
                    version = clean_characters(line,'[Vv]ersion',':')
                elif (re.split('[Vv]ersion', line)[1].strip().startswith('-')):
                    version = clean_characters(line,'[Vv]ersion','-')
                elif (re.split('[Vv]ersion', line)[1].startswith(' ')):
                    version = clean_white(line,'[Vv]ersion')

            # Search and check where it has been tested
            if re.search('[Tt]ested [Oo]n', line):
                if (re.split('[Tt]ested [Oo]n', line)[1].strip().startswith(':')):
                    tested = clean_characters(line,'[Tt]ested [Oo]n',':')
                elif (re.split('[Tt]ested [Oo]n', line)[1].strip().startswith('-')):
                    tested = clean_characters(line,'[Tt]ested [Oo]n','-')
                elif (re.split('[Tt]ested [Oo]n', line)[1].startswith(' ')):
                    tested = clean_white(line,'[Tt]ested [Oo]n')

            # Search and check the CVE
            if line.__contains__('CVE ID'):
                if (line.partition('CVE ID')[2].strip().startswith(':')):
                    CVE = clean_characters(line,'CVE ID',':')
                elif (line.partition('CVE ID')[2].strip().startswith('-')):
                    CVE = clean_characters(line,'CVE ID','-')
                elif (line.partition('CVE ID')[2].startswith(' ')):
                    CVE = clean_white(line,'CVE ID')
            elif line.__contains__('CVE'):
                if (line.partition('CVE')[2].strip().startswith(':')):
                    CVE = clean_characters(line,'CVE',':')
                elif (line.partition('CVE')[2].strip().startswith('-')):
                    CVE = clean_characters(line,'CVE','-')
                elif (line.partition('CVE')[2].startswith(' ')):
                    CVE = clean_white(line,'CVE')

        # Add the new values to the values tuple
        values = values + (seller_link,)
        values = values + (software_link,)
        values = values + (version,)
        values = values + (tested,)
        values = values + (CVE,)

    # print(values)
    return values

# Clean with characters
def clean_characters(line, word, character):
    if (word == 'CVE' or word == 'CVE ID'):
        return line.partition(word)[2].split(character,1)[1].translate({ord(i): None for i in '[]'}).strip()
    else: 
        return re.split(word, line)[1].split(character,1)[1].translate({ord(i): None for i in '[]'}).strip()

# Clean with white space
def clean_white(line, word):
    if (word == 'CVE' or word == 'CVE ID'):
        return line.partition(word)[2].translate({ord(i): None for i in '[]'}).strip()
    else:
        return re.split(word, line)[1].translate({ord(i): None for i in '[]'}).strip()

if __name__ == "__main__":
    init()
    compatible_OS()
    mysql_installed()
    mysql_status()
    searchsploit_installed()
    nodejs_installed()
    node_modules_installed()
    create_database()
    # search_content('prueba.txt', ('1','2'))
